(()=>{var e={};e.id=9849,e.ids=[9849],e.modules={72934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27790:e=>{"use strict";e.exports=require("assert")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},92048:e=>{"use strict";e.exports=require("fs")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},19801:e=>{"use strict";e.exports=require("os")},55315:e=>{"use strict";e.exports=require("path")},76162:e=>{"use strict";e.exports=require("stream")},74175:e=>{"use strict";e.exports=require("tty")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},65907:(e,t,r)=>{"use strict";r.r(t),r.d(t,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>p,pages:()=>c,routeModule:()=>u,tree:()=>n}),r(7480),r(11506),r(96560);var a=r(23191),o=r(88716),s=r(37922),i=r.n(s),l=r(95231),d={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(d[e]=()=>l[e]);r.d(t,d);let n=["",{children:["elijeProveedores",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(r.bind(r,7480)),"D:\\Documents\\GitHub\\voltAdmin\\app\\elijeProveedores\\page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(r.bind(r,11506)),"D:\\Documents\\GitHub\\voltAdmin\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(r.bind(r,96560)),"D:\\Documents\\GitHub\\voltAdmin\\app\\not-found.tsx"]}],c=["D:\\Documents\\GitHub\\voltAdmin\\app\\elijeProveedores\\page.tsx"],p="/elijeProveedores/page",m={require:r,loadChunk:()=>Promise.resolve()},u=new a.AppPageRouteModule({definition:{kind:o.x.APP_PAGE,page:"/elijeProveedores/page",pathname:"/elijeProveedores",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:n}})},13234:(e,t,r)=>{Promise.resolve().then(r.bind(r,97818))},97818:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>S});var a=r(10326),o=r(35047),s=r(17577),i=r(77109),l=r(23703),d=r(10123);let n=(e,t)=>e.replace(/\{(\w+)\}/g,(e,r)=>t[r]||`{${r}}`).replace(/\\n/g,"<br>").replace(/\n/g,"<br>"),c=async(e,t,r)=>{let a=e.proveedores.filter(t=>e.proveedoresSelected.includes(t.id)),o=await m(a,e.selectedTemplate);if(!o||0===o.length)return alert("Error no est\xe1n definidos los meta datos.");let s=e.jsFiles.filter(t=>e.anexosSelected.includes(t.id)).map(e=>({filePath:e.filePath,fileType:e.fileType,filename:e.filename})),i=o.map(e=>({email:e.email,contacto:e.contacto,asunto:e.asunto,cuerpoEmail:e.cuerpoEmail,userId:t,url:e.url,proveedorId:e.proveedor.id,attach:s,token:e.token}));try{let e=await fetch("/api/sendEmail",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sendTo:o,attachments:s})}),t=await e.json();e.ok?(alert("\uD83D\uDCE9 Email enviado correctamente."),console.log("✅ Respuesta del servidor:",t)):(alert("⚠️ Error al enviar el email."),console.error("❌ Error:",t.error))}catch(e){alert("⚠️ Error en la conexi\xf3n con el servidor."),console.error("❌ Error:",e)}p(r,t,e.idTransaction,e.numActividad,e.actividad,e.fechaInicio,e.fechaTermino,e.presupuesto,i,s)},p=async(e,t,r,a,o,s,i,l,d,n)=>{try{let c=await fetch("/api/saveWithJson",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({storedProcedure:"UpdateProveedorToken",parameters:{idTask:e,userId:t,idTransaction:r,numActividad:a,actividad:o,fechaInicio:s,fechaTermino:i,presupuesto:l,proveedores:d,attach:n}})});if(!c.ok){let e=await c.json();return{success:!1,error:e.message||c.statusText}}let p=await c.json();return{success:!0,result:p}}catch(e){return{success:!1,error:e}}},m=async(e,t)=>{if(!e||0===e.length||!t)return;let r=t.bodyTemplate,a=t.subjectTemplate,o=[];for(let t of e){let e=n(a,t.placeholders),s=n(r,t.placeholders);try{let r=await fetch("/api/generateToken",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({proveedorId:t.id})}),a=await r.json();if(!a.token)throw Error("No se pudo generar el token");let i=a.token,l=`http://localhost:3000/cotizar?token=${encodeURIComponent(i)}`;s=s.replace("{CotizacionURL}",l),o.push({proveedorId:t.id,email:t.email,contacto:t.contacto,label:t.label,proveedor:t,placeholders:t.placeholders,asunto:e,cuerpoEmail:s,url:l,token:i})}catch(e){console.error(`Error generando token para proveedor ${t.id}:`,e)}}return o},u=async(e,t,r)=>{try{let a=await fetch(`/api/getActivityFromTask?idTask=${e} &userId=${t}`);if(!a.ok)throw Error(`Failed to fetch form data: ${a.statusText}`);let o=await a.json(),s="string"==typeof o.emailTemplate?JSON.parse(o.emailTemplate):o.emailTemplate,i=[{idEmailTemplate:0,templateName:"",subjectTemplate:"",bodyTemplate:"",metadataJSON:""}];s&&s.length>0&&(i=s.map(e=>{let t="string"==typeof e.metadataJSON?JSON.parse(e.metadataJSON):e.metadataJSON;return{idEmailTemplate:e.idEmailTemplate,templateName:e.templateName,subjectTemplate:e.subjectTemplate,bodyTemplate:e.bodyTemplate,metadataJSON:t}}));let l="string"==typeof o.jsFiles?JSON.parse(o.jsFiles):o.jsFiles,d=("string"==typeof o.proveedores?JSON.parse(o.proveedores):o.proveedores).map(e=>{let t="string"==typeof e.placeholders?JSON.parse(e.placeholders):e.placeholders;return{...e,placeholders:t}});r({numActividad:o.numActividad,actividad:o.actividad,fechaInicio:o.fechaInicio,fechaTermino:o.fechaTermino,duracion:o.duracion,presupuesto:o.presupuesto,responsable:o.responsable,formaEjecucion:o.formaEjecucion,periodoControl:o.periodoControl,ejecutor:o.ejecutor,idProjectActivity:o.idProjectActivity,idTask:o.idTask,idTransaction:o.idTransaction,idProject:o.idProject,projectName:o.projectName,ubicacionPanel:o.ubicacionPanel,nroInstalaciones:o.nroInstalaciones,tipoTerreno:o.tipoTerreno,nivelPiedras:o.nivelPiedra,nivelFreatico:o.nivelFreatico,jsFiles:l,emailTemplate:i,selectedTemplate:null,proveedores:d,anexosSelected:[],proveedoresSelected:[],selectedTemplateId:0});return}catch(e){console.log("error",e)}};var h=r(40959),v=r(34548),x=r(29497),g=r(43440),j=r(58145);let f=e=>{let t=e.replace(/([a-z])([A-Z])/g,"$1 $2");return t.charAt(0).toUpperCase()+t.slice(1)},b=({proveedoresOptions:e,filesOptions:t})=>(0,a.jsxs)("div",{className:"mb-1 flex items-start space-x-2",children:[e.length>0&&a.jsx("div",{className:"w-3/8",children:a.jsx(l.gN,{as:v.AP,multiple:!0,label:"Proveedores a cotizar",name:"proveedoresSelected",options:e||[],placeholder:"Defina proveedores a cotizar",width:"100%",required:!0})}),t.length>0&&a.jsx("div",{className:"w-5/8",children:a.jsx(l.gN,{as:v.AP,multiple:!0,label:"Anexos a adjuntar",name:"anexosSelected",options:t||[],placeholder:"Defina archivos a enviar al proveedor",width:"100%"})})]}),y=({emailOptions:e,values:t,setFieldValue:r,setEditableBody:o,placeholders:s})=>a.jsx("div",{className:"p-6 max-w-5xl mx-auto bg-white rounded-lg shadow",children:a.jsx("div",{className:"w-3/5",children:a.jsx(l.gN,{as:v.AP,label:"Plantilla del email a enviar (1ero defina proveedores a cotizar)",name:"selectedTemplateId",options:e||[],enabled:t.proveedoresSelected?.length>0,placeholder:"Defina el formato del email a enviar al proveedor",width:"80%",onChange:e=>{let a=Number(e);r("selectedTemplateId",a);let i=t.emailTemplate.find(e=>e.idEmailTemplate===a);o(i?n(i.bodyTemplate,s):""),r("selectedTemplate",i||null)}})})}),T=({editableBody:e,values:t,placeholders:r})=>t.selectedTemplate&&t.proveedoresSelected&&0!==t.proveedoresSelected.length?a.jsx("div",{className:"p-4 max-w-5xl mx-auto bg-white rounded-lg shadow",children:(0,a.jsxs)("div",{className:"border p-4 rounded-md bg-gray-100",children:[a.jsx("h3",{className:"font-semibold",children:"\uD83D\uDCCC Asunto:"}),a.jsx("p",{className:"text-gray-800 mb-2",children:n(t.selectedTemplate.subjectTemplate,r)}),a.jsx("h3",{className:"font-semibold",children:"\uD83D\uDCE9 Cuerpo del correo:"}),a.jsx("div",{className:"bg-white p-3 rounded text-gray-800 border",dangerouslySetInnerHTML:{__html:e.replace("{CotizacionURL}",r.CotizacionURL.length>0?r.CotizacionURL:"http:\\evolusol...")}})]})}):null,N=({handleSendEmail:e})=>{let{values:t}=(0,l.u6)(),r=Array.isArray(t.proveedoresSelected)?t.proveedoresSelected.length:0;return t.selectedTemplate&&0!==r?(0,a.jsxs)("button",{className:"mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition",onClick:()=>e(t),type:"button",children:["\uD83D\uDCE9 Enviar correo a ",r," ",1===r?"proveedor":"proveedores"]}):null},P=d.Ry({proveedoresSelected:d.IX().min(1,"Debe seleccionar al menos un proveedor"),selectedTemplate:d.Ry().nullable().required("Debe seleccionar una plantilla")}),S=()=>{let e=(0,o.useRouter)(),t=(0,o.useSearchParams)(),{data:r,status:d}=(0,i.useSession)(),[p,m]=(0,s.useState)(!0),[S,w]=(0,s.useState)(!1),[C,E]=(0,s.useState)(),[A,q]=(0,s.useState)(),[D,k]=(0,s.useState)(),[F,I]=(0,s.useState)(""),O=Number(t?.get("idTask")),[z,J]=(0,s.useState)(0),[_,G]=(0,s.useState)({}),[R,$]=(0,s.useState)({numActividad:"",actividad:"",fechaInicio:"",fechaTermino:"",duracion:0,presupuesto:0,idTask:0,idTransaction:0,idProjectActivity:0,idProject:0,projectName:"",responsable:"",formaEjecucion:"",periodoControl:"",ejecutor:"",ubicacionPanel:"",nroInstalaciones:1,tipoTerreno:"",nivelPiedras:"",nivelFreatico:0,jsFiles:[],emailTemplate:[],selectedTemplate:null,proveedores:[],anexosSelected:[],proveedoresSelected:[],selectedTemplateId:0});if((0,s.useEffect)(()=>{let e=async e=>{try{r?.user.id&&await u(e,r.user.id,$)}catch(e){console.log("error",e)}};m(!0),O&&O>0&&e(O)},[O,r?.user.id]),(0,s.useEffect)(()=>{R.idProjectActivity&&R.idProjectActivity>0&&m(!1)},[R.idProjectActivity]),(0,s.useEffect)(()=>{R.proveedores&&R.proveedores.length>0&&E(R.proveedores.map(e=>({label:e.label,value:e.id})))},[R.proveedores]),(0,s.useEffect)(()=>{R.jsFiles&&R.jsFiles.length>0&&q(R.jsFiles.map(e=>({label:e.descripcion,value:e.id})))},[R.jsFiles]),(0,s.useEffect)(()=>{R.emailTemplate&&R.emailTemplate.length>0&&k(R.emailTemplate.map(e=>({label:e.templateName,value:e.idEmailTemplate})))},[R.emailTemplate]),p)return a.jsx(h.T,{message:"cargando"});if(S)return a.jsx(h.T,{message:"enviando correos"});let L=(e,t)=>{let r=Number(t);if(e.proveedores&&r!==z){let t=e.proveedores.map(e=>e.id===z?{...e,placeholders:_}:e);if(!(0,j.q)(e.proveedores,t)&&!window.confirm(String.fromCodePoint(9888)+" Al cambiar de proveedor, perder\xe1 lo realizado. Para guardar presione aqu\xed <cancelar> y luego, <guardar cambios> "))return}let a=e.proveedores?.filter(e=>e.id===r)[0];a&&(J(r),G(a.placeholders))},M=(e,t,r)=>{G(a=>{let o={...a,[t]:r};return e.selectedTemplate&&I(n(e.selectedTemplate.bodyTemplate,o)),o})},U=async t=>{if(!t.selectedTemplate)return alert("Selecciona una plantilla antes de enviar.");if(!t.proveedoresSelected||0===t.proveedoresSelected.length||!t.proveedores||0===t.proveedores.length)return alert("Seleccione proveedores a enviar correo.");w(!0);let a=r?.user.id?r?.user.id:0;await c(t,a,O),w(!1),e.push("/")};return(0,a.jsxs)(a.Fragment,{children:["  ",(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsxs)("p",{className:"text-3xl font-bold text-center",children:[" Define proveedores de la actividad ",R.numActividad]}),(0,a.jsxs)("p",{className:"text-2xl font-bold text-center",children:[" ",`Proceso: (N\xb0${R.idProject}) "${R.projectName}"`]}),a.jsx(l.J9,{initialValues:R,validationSchema:P,enableReinitialize:!0,onSubmit:e=>{console.log("Formulario enviado con valores:",e)},children:({values:e,errors:t,touched:r,setFieldValue:o})=>{if(z>0&&_&&e.emailTemplate&&e.emailTemplate.length>0){let t=n(e.emailTemplate[0].bodyTemplate,_);F!==t&&I(t)}return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(l.l0,{id:"emailForm",children:[a.jsx("div",{className:"mb-1 flex items-start space-x-2",children:a.jsx("div",{className:"w-3/5",children:a.jsx(l.gN,{name:"actividad",type:"text",as:v.t7,label:"Descripci\xf3n de la actividad",placeholder:"Ingresa la descripci\xf3n de la actividad",error:r.actividad&&t.actividad?t.actividad:void 0,required:!0,theme:"light",width:"100%",onChange:e=>o("actividad",e.target.value)})})}),(0,a.jsxs)("div",{className:"mb-1 flex items-start space-x-2",children:[a.jsx("div",{className:"w-1/5",children:a.jsx(l.gN,{name:"fechaInicio",as:v.ld,label:"Fecha de inicio",placeholder:"Ingresa la fecha de inicio",required:!0,theme:"light",width:"100%",format:"dd-MM-yyyy"})}),a.jsx("div",{className:"w-1/5",children:a.jsx(l.gN,{name:"fechaTermino",as:v.ld,label:"Fecha de t\xe9rmino",placeholder:"Ingresa la fecha de t\xe9rmino",required:!0,theme:"light",width:"100%",format:"dd-MM-yyyyy",onChange:e=>o("fechaInicio",e.target.value)})}),a.jsx("div",{className:"w-1/5",children:a.jsx(v.UN,{label:`(Duraci\xf3n en d\xedas: ${e.duracion}) `,size:"normal+"})})]}),(0,a.jsxs)("div",{className:"mb-1 flex items-start space-x-2",children:[a.jsx("div",{className:"w-1/5",children:a.jsx(l.gN,{name:"presupuesto",type:"number",as:v.t7,label:"Presupuesto",placeholder:"Ingresa presupuesto de la actividad",error:r.presupuesto&&t.presupuesto?t.presupuesto:void 0,theme:"light",width:"70%",onChange:e=>o("presupuesto",e.target.value),textAlign:"right",style:{marginTop:"2px"}})}),C&&C.length>0&&A&&a.jsx(b,{proveedoresOptions:C,filesOptions:A})]}),a.jsx("div",{className:"p-6 max-w-5xl mx-auto bg-white rounded-lg shadow",children:D&&(0,a.jsxs)(a.Fragment,{children:[a.jsx(y,{emailOptions:D,values:e,setFieldValue:o,setEditableBody:I,placeholders:_}),e.selectedTemplate&&(0,a.jsxs)("div",{className:"mb-3 mp-6 flex items-start space-x-2",children:["  ",(0,a.jsxs)(a.Fragment,{children:[a.jsx("h3",{className:"text-lg font-semibold mt-4",children:"✏️ Edita los Valores"}),a.jsx("div",{className:"grid grid-cols-2 gap-1 mb-4",children:a.jsx(a.Fragment,{children:e.proveedores&&e.proveedoresSelected&&e.proveedores.length>0&&e.proveedoresSelected.length>0&&(0,a.jsxs)("div",{className:"grid-cols-3 gap-1 mb-4 ml-1",children:[a.jsx("label",{className:"block text-sm font-medium",children:"Elija proveedor a revisar"}),a.jsx(v.AP,{label:"",width:"180px",theme:"light",value:String(z),onChange:t=>L(e,t),options:e.proveedores.filter(t=>e.proveedoresSelected.includes(t.id)).map(e=>({value:e.id,label:e.label}))})]})})}),z>0&&a.jsx("div",{className:"grid grid-cols-2 gap-3 mb-4",children:Object.keys(_).map(t=>"CotizacionURL"!==t&&"Actividad"!==t&&"NombreContratante"!==t&&("Observacion"===t?a.jsx("div",{className:"col-span-2",children:a.jsx(v.t7,{label:"Observaci\xf3n que inserta en el mensaje",width:"100%",name:t,value:_[t],theme:"light",onChange:r=>M(e,t,r.target.value),maxLength:300,rows:2,multiline:!0})},t):(0,a.jsxs)("div",{children:[a.jsx("label",{className:"block text-sm font-medium",children:f(t)}),a.jsx(v.t7,{label:"",width:"200px",theme:"light",name:t,value:_[t],onChange:r=>M(e,t,r.target.value)})]},t)))})]})]}),z>0&&(0,a.jsxs)("div",{className:"mt-1 mb-2 flex justify-end ",children:[a.jsx(v.op,{buttonStyle:"secondary",size:"small",htmlType:"button",label:"cancelar",tooltipContent:"elimina y cierra cambios editados proveedor",tooltipPosition:"top",style:{marginLeft:5},icon:a.jsx(x.G,{icon:g.J9Y,size:"lg",color:"white"}),onClick:()=>{if(e.proveedores){let t=e.proveedores.map(e=>e.id===z?{...e,placeholders:_}:e),r=(0,j.q)(e.proveedores,t);if(!r&&window.confirm(String.fromCodePoint(9888)+"\xbfEst\xe1 seguro de cerrar modificaciones y perderlas?"))return}J(0)}}),a.jsx(v.op,{buttonStyle:"secondary",size:"small",htmlType:"button",label:"aplicar cambios",tooltipContent:"guardar los cambios editados",tooltipPosition:"top",style:{marginLeft:5},icon:a.jsx(x.G,{icon:g.J9Y,size:"lg",color:"white"}),onClick:()=>{if(e.proveedores){let t=e.proveedores.map(e=>e.id===z?{...e,placeholders:_}:e);(0,j.q)(e.proveedores,t)||(o("proveedores",t),J(0),setTimeout(()=>{window.confirm(String.fromCodePoint(9989)+"Modificaciones guardadas"),window.focus()},0))}}})]})]})})]}),e.selectedTemplate&&e.proveedoresSelected&&z>0&&a.jsx(T,{editableBody:F,values:e,placeholders:_}),0===z&&a.jsx(N,{handleSendEmail:U}),"   "]})}}),a.jsx("div",{className:"mt-3 flex items-start ",children:a.jsx(v.op,{buttonStyle:"primary",size:"small",htmlType:"button",label:"Volver al p\xe1gina anterior",tooltipContent:"Volver a seleccionar otra actividad",tooltipPosition:"right",style:{marginLeft:5},icon:a.jsx(x.G,{icon:g.J9Y,size:"lg",color:"white"}),onClick:()=>{window.confirm(String.fromCodePoint(9888)+"\xbfEst\xe1 seguro de cerrar el formulario y perder lo modificado?")&&e.back()}})})]})," "]})}},7480:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>a});let a=(0,r(68570).createProxy)(String.raw`D:\Documents\GitHub\voltAdmin\app\elijeProveedores\page.tsx#default`)}};var t=require("../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,9154,123,4258],()=>r(65907));module.exports=a})();