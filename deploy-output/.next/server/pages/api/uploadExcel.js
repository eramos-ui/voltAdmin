"use strict";(()=>{var e={};e.id=7397,e.ids=[7397],e.modules={20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},92048:e=>{e.exports=require("fs")},56249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},17757:(e,r,t)=>{t.r(r),t.d(r,{config:()=>F,default:()=>_,routeModule:()=>T});var n={};t.r(n),t.d(n,{config:()=>S,default:()=>j});var a=t(71802),i=t(47153),o=t(56249);let s=require("multer");var l=t.n(s);let u=(e,r,t)=>new Promise((n,a)=>{t(e,r,e=>{if(e instanceof Error)return a(e);n(e)})}),c=require("xlsx");var d=t(92048),p=t.n(d);let m=require("dayjs");var f=t.n(m);let h=require("dayjs/plugin/customParseFormat");var P=t.n(h);f().extend(P());let g=(e,r)=>{if(!e||!r)return null;let t=f()(e,["DD/MM/YYYY"],!0),n=f()(r,["DD/MM/YYYY"],!0);return t.isValid()&&n.isValid()?n.diff(t,"day"):null},v=l()({dest:"uploads/"}),y=e=>e.trim().replace(/['"]/g,"").replace(/\s+/g," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()).join(""),E=e=>{let r=[],t=c.utils.decode_range(e["!ref"]||"");if(t.s&&t.e)for(let n=t.s.c;n<=t.e.c;n++){let a=e[c.utils.encode_cell({r:t.s.r,c:n})];if(a&&a.v){let e=y(String(a.v)),t={name:e,inputType:"text",type:"string"};e.startsWith("Fecha")?t={name:e,inputType:"date",type:"string"}:"Presupuesto"===e&&(t={name:e,inputType:"number",type:"number"}),r.push(t)}}let n=r.findIndex(e=>"FechaTermino"===e.name);return -1!==n?r.splice(n+1,0,{name:"Duracion",inputType:"number",type:"number"}):r.push({name:"Duracion",inputType:"number",type:"number"}),r},A=e=>{let r=c.SSF.parse_date_code(e);if(!r)return"";let t=String(r.d).padStart(2,"0"),n=String(r.m).padStart(2,"0"),a=String(r.y);return`${t}/${n}/${a}`},b=e=>e.map(e=>{let r={};return Object.keys(e).forEach(t=>{let n=y(t),a=e[t];n.startsWith("Fecha")&&"number"==typeof a&&(a=A(a)),"Presupuesto"===n&&(a=isNaN(Number(a))?0:Number(a)),r[n]="string"==typeof a?a.trim():a}),r}),x=e=>{let r=/^\d+d$/;for(let[t,n]of e.entries())if("Plazo"in n){let e=n.Plazo;if(""!==e&&!r.test(e))throw Error(`Error en la fila ${t+2}: El campo "Plazo" debe estar en blanco o tener un valor en formato "Nd" (Ejemplo: "3d", "7d").`)}},S={api:{bodyParser:!1}},j=async(e,r)=>{if("POST"!==e.method)return r.status(405).json({message:"Method not allowed"});try{await u(e,r,v.single("file"));let t=e.file;if(!t)return r.status(400).json({message:"No se subi\xf3 ning\xfan archivo."});console.log("Archivo recibido en API uploadExcel:",t.originalname);let n=c.readFile(t.path),a=n.SheetNames[0],i=n.Sheets[a],o=E(i),s=c.utils.sheet_to_json(i);if(!(s=b(s)).length)return r.status(400).json({message:"El archivo Excel est\xe1 vac\xedo."});let l=["NumActividad","Actividad","Presupuesto","FechaInicio","FechaTermino"].filter(e=>!o.some(r=>r.name===e));if(l.length>0)return r.status(400).json({message:`El archivo Excel debe incluir las siguientes columnas: ${l.join(", ")}`});s=s.map(e=>({...e,NumActividad:void 0!==e.NumActividad?String(e.NumActividad):""})),x(s),s=s.map(e=>{let r=e.FechaInicio||e["Fecha Inicio"],t=e.FechaTermino||e["Fecha T\xe9rmino"];return t&&(e.Duracion=g(r,t)??" "),e}),r.status(200).json({message:"Archivo procesado correctamente",data:s,excelColumns:o})}catch(e){console.error("Error en la API uploadExcel:",e),r.status(500).json({message:"Error en el servidor al procesar el archivo.",error:e.message||"Error desconocido"})}finally{e.file?.path&&p().unlinkSync(e.file.path)}},_=(0,o.l)(n,"default"),F=(0,o.l)(n,"config"),T=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/uploadExcel",pathname:"/api/uploadExcel",bundlePath:"",filename:""},userland:n})},47153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},71802:(e,r,t)=>{e.exports=t(20145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=17757);module.exports=t})();