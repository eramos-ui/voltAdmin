"use strict";(()=>{var e={};e.id=6625,e.ids=[6625],e.modules={55107:e=>{e.exports=require("@azure/storage-blob")},19424:e=>{e.exports=require("mssql")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},62270:(e,t,r)=>{r.r(t),r.d(t,{config:()=>h,default:()=>P,routeModule:()=>y});var o={};r.r(o),r.d(o,{default:()=>d});var a=r(71802),l=r(47153),n=r(56249),i=r(18023),s=r(55107);let c=process.env.AZURE_STORAGE_ACCOUNT_NAME,f=process.env.AZURE_STORAGE_ACCOUNT_KEY,u=new s.StorageSharedKeyCredential(c,f);async function d(e,t){if("GET"!==e.method)return t.status(405).json({error:"M\xe9todo no permitido"});let{idTask:r,userId:o}=e.query;if(!r)return t.status(400).json({error:"idTask is required"});try{let e=`EXEC getProjectFromTask @idTask= ${Number(r)}, @userId = ${Number(o)}`,a=await (0,i.JT)(e);if(!a||0===a.length)return t.status(404).json({error:"Proyecto no encontrado"});console.log("✅ getProjectFromTask OK");let l=JSON.parse(JSON.stringify(a)),n=l[0].idProject,s=l[0],c=`EXEC filesFromProject @idProject= ${Number(n)}`,f=await (0,i.JT)(c),u=JSON.parse(JSON.stringify(f)),d=u.find(e=>e.fileName.endsWith(".xlsx")),P=u.find(e=>e.fileName.endsWith(".kml")),h={...s,excelFile:{fileClass:d?.fileClass||"Activities",fileName:d?.fileName||null,fileType:d?.fileType||null,row:"global",fileContent:d?Buffer.from(d.fileData.data).toString("base64"):null},kmlFile:{fileClass:P?.fileClass||"KML",fileName:P?.fileName||null,fileType:P?.fileType||null,row:"global",fileContent:P?.fileContent||null},activities:s.activities?JSON.parse(s.activities):[],empalmesGrid:s.empalmesGrid?JSON.parse(s.empalmesGrid):[],instalacionesGrid:s.instalacionesGrid?JSON.parse(s.instalacionesGrid):[],techoGrid:s.techoGrid?JSON.parse(s.techoGrid):[]};console.log("\uD83D\uDD11 En getProjectFromTask projectFiles:",h);let y=(await Promise.all(u.map(async e=>{if(!e)return null;let t=e.lastModified||Date.now(),r=null;if(e.fileData){try{Buffer.isBuffer(e.fileData)?r=e.fileData.toString("base64"):"object"==typeof e.fileData&&"Buffer"===e.fileData.type&&Array.isArray(e.fileData.data)&&(r=Buffer.from(e.fileData.data).toString("base64"))}catch(t){console.error(`❌ Error al convertir a Base64: ${e.fileName}`,t)}let o=e.fileData?.data?Buffer.byteLength(Buffer.from(e.fileData.data)):0;return{fileClass:e.fileClass,fileName:e.fileName,fileType:e.fileType,fileSize:o,lastModified:t,row:e.fileClass.includes("Activities")?"global":e.row,fileContent:r}}if(e.fileContent){let r=e.fileContent.length;return{fileClass:e.fileClass,fileName:e.fileName,fileType:e.fileType,fileSize:r,lastModified:t,row:e.fileClass.includes("KML")?"global":e.row,fileContent:e.fileContent}}if(e.filePath&&p(e.filePath))try{let r=await m(e.filePath),o=await fetch(r);if(!o.ok)throw Error(`Error leyendo archivo: ${r}`);let a=await o.arrayBuffer(),l=Buffer.from(a),n=l.length;return{fileClass:e.fileClass,fileName:e.fileName,fileType:e.fileType,filePath:e.filePath,fileSize:n,lastModified:t,row:e.row,fileContent:l.toString("base64")}}catch(t){console.error(`❌ Error leyendo archivo desde Azure: ${e.filePath}`,t)}return null}).filter(Boolean))).reduce((e,t)=>(t.row&&(e[t.row]||(e[t.row]=[]),e[t.row].push({fileClass:t.fileClass,fileName:t.fileName,fileType:t.fileType,fileSize:t.fileSize,lastModified:t.lastModified,filePath:t.filePath||null,fileContent:t.fileContent||null})),e),{});t.status(200).json({project:h,files:y})}catch(e){console.error("❌ Error al obtener datos del proyecto:",e),t.status(500).json({error:"Error fetching task data"})}}let p=e=>e.startsWith("https://")&&e.includes(".blob.core.windows.net");async function m(e){let t=new s.BlobServiceClient(`https://${c}.blob.core.windows.net`,u),[,r,...o]=new URL(e).pathname.split("/"),a=o.join("/"),l=t.getContainerClient(r).getBlobClient(a),n=new Date(new Date().valueOf()+36e5),i=(0,s.generateBlobSASQueryParameters)({containerName:r,blobName:a,permissions:s.BlobSASPermissions.parse("r"),expiresOn:n},u).toString();return`${l.url}?${i}`}let P=(0,n.l)(o,"default"),h=(0,n.l)(o,"config"),y=new a.PagesAPIRouteModule({definition:{kind:l.x.PAGES_API,page:"/api/getProjectFromTask",pathname:"/api/getProjectFromTask",bundlePath:"",filename:""},userland:o})},11001:(e,t,r)=>{r.d(t,{P:()=>n});var o=r(19424),a=r.n(o);let l={isConnected:0,pool:null};async function n(){if(l.isConnected&&l.pool)return console.log("✅ En connectToDB ya existe una conexi\xf3n",l.pool),l.pool;try{let e=function(){let e=process.env.DATABASE_URL;if(e){let t=new URL(e),[r,o]=t.username?[t.username,t.password]:[void 0,void 0];return{user:r,password:o,server:t.hostname,port:parseInt(t.port||"1433",10),database:t.searchParams.get("database")||"",options:{trustServerCertificate:!0,encrypt:!0},connectionTimeout:3e4}}return{user:process.env.DB_USER||"sa",password:process.env.DB_PASSWORD||"as",server:process.env.DB_SERVER||"localhost",database:process.env.DB_NAME||"fotvAdmin",options:{trustServerCertificate:!0,encrypt:!0},port:Number(process.env.DB_PORT||1433),connectionTimeout:3e4,requestTimeout:6e4}}(),t=await a().connect(e);return l.isConnected=1,l.pool=t,console.log("✅ En getDbConfig Conexi\xf3n a SQL Server establecida"),t}catch(e){throw console.error("❌ Error conectando a SQL Server:",e),e}}},18023:(e,t,r)=>{r.d(t,{B3:()=>n,JT:()=>l,Jz:()=>i,OB:()=>a,nS:()=>s});var o=r(11001);let a=async(e,t=[])=>{try{console.log(`▶️ Ejecutando SP: ${e} con nro. params:`,t.length);let r=(await (0,o.P)()).request();t.forEach(e=>{r.input(e.name,e.type,e.value)});let a=await r.execute(e);return console.log(`✅ SP ejecutado correctamente: ${e}`),a.recordset}catch(r){throw console.error(`❌ Error ejecutando SP "${e}" con par\xe1metros:`,t),console.error("\uD83E\uDDE8 Detalles del error:",r),r}},l=async(e,t=[])=>{console.log("En executeQuery connectToDB",o.P);try{console.log(`📥 Ejecutando consulta: "${e}" con params:`,t);let r=(await (0,o.P)()).request();t.forEach(e=>{r.input(e.name,e.type,e.value)});let a=await r.query(e);return console.log(`✅ Consulta ${e} ejecutada correctamente (${a.recordset.length} filas)`),a.recordset}catch(t){throw console.error(`❌ Error ejecutando consulta SQL: "${e}"`),console.error("\uD83E\uDDE8 Detalles del error:",t),t}},n=async(e,t=[])=>{try{let r=(await (0,o.P)()).request();return t.forEach(e=>{r.input(e.name,e.type,e.value)}),(await r.execute(e)).rowsAffected[0]??!0}catch(t){throw console.error(`❌ Error ejecutando SP "${e}"`,t),t}},i=async(e,t=[])=>{let r=await l(e,t);return r.length>0?r[0]:null},s=async(e,t=[])=>{try{let r=(await (0,o.P)()).request();t.forEach(e=>r.input(e.name,e.type,e.value));let a=await r.execute(e);return console.log(`✅ En executeSPScalar ${e}`),a.recordset.length>0?a.recordset[0]:null}catch(t){return console.error(`❌ Error en executeSPScalar SP "${e}":`,t),null}}},47153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},71802:(e,t,r)=>{e.exports=r(20145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=62270);module.exports=r})();