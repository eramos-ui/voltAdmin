"use strict";(()=>{var e={};e.id=194,e.ids=[194],e.modules={55107:e=>{e.exports=require("@azure/storage-blob")},19424:e=>{e.exports=require("mssql")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},56249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},84683:(e,r,t)=>{t.r(r),t.d(r,{config:()=>y,default:()=>g,routeModule:()=>P});var o={};t.r(o),t.d(o,{config:()=>p,default:()=>m});var a=t(71802),n=t(47153),l=t(56249),i=t(18023),s=t(55107);let c=process.env.AZURE_STORAGE_CONNECTION_STRING;async function u({fileName:e,fileData:r,fileType:t,fileClass:o,userId:a,rowId:n}){let l=s.BlobServiceClient.fromConnectionString(c).getContainerClient("documentos"),i=`${o}/${a}/${n}/${e}`,u=l.getBlockBlobClient(i),d=Buffer.from(r,"base64");return await u.uploadData(d,{blobHTTPHeaders:{blobContentType:t}}),u.url}var d=t(19424),f=t.n(d);let p={api:{bodyParser:!0}};async function m(e,r){if("POST"!==e.method)return r.status(405).json({error:"M\xe9todo no permitido"});let{values:t,excelFile:o,kmlFile:a,empalmesGrid:n,instalacionesGrid:l,techoGrid:s,state:c}=e.body,d=t.userId;try{let e={...t,userId:String(d),state:c},p=Buffer.from(JSON.stringify(e),"utf8").toString(),m=await (0,i.nS)("UpdateProject",[{name:"jsonData",type:f().NVarChar(f().MAX),value:p}]),g=m?.idProject;if(!g)throw Error("No se pudo guardar el proyecto.");let y=async(e,r)=>{if(!e||!e.fileName)return;let t=await (0,i.nS)("isFileAlredyUploaded",[{name:"jsonData",type:f().NVarChar(f().MAX),value:JSON.stringify({idProject:g,userId:String(d),fileName:e.fileName})}]);if(t?.existe==="true")return;let o=Buffer.from(e.fileData,"base64"),a=o.toString("utf-8"),n={idProject:g,fileClass:r,userId:String(d),rowId:"",fileName:e.fileName,fileType:e.fileType,fileData:"application/vnd.google-earth.kml+xml"!==e.fileType?o:null,fileContent:"application/vnd.google-earth.kml+xml"===e.fileType?a:null};await (0,i.OB)("UpdateProjectFile",[{name:"jsonData",type:f().NVarChar(f().MAX),value:Buffer.from(JSON.stringify(n),"utf8").toString()}])},P=async(e,r,t,o)=>{if(!r)return;let a=await (0,i.nS)("isFileAlredyUploaded",[{name:"jsonData",type:f().NVarChar(f().MAX),value:JSON.stringify({idProject:e,userId:String(d),fileName:r.fileName})}]);if(a?.existe==="true")return;let{fileName:n,fileData:l,fileType:s}=r,c=await u({fileName:n,fileData:l,fileType:s,fileClass:t,userId:String(d),rowId:o});console.log("\uD83D\uDD11 en saveFileToAzureAndRegister downloadUrl:",c);let p={idProject:e,fileClass:t,userId:String(d),fileName:n,fileType:s,rowId:o,filePath:c};await (0,i.OB)("UpdateProjectFile",[{name:"jsonData",type:f().NVarChar(f().MAX),value:JSON.stringify(p)}])};await Promise.all([y(a,"KML"),y(o,"Activities")]);let S=async(e,r,t)=>{for(let o of e){let e=Array.isArray(t)?t.map(e=>String(o[e])).join("_"):String(o[t]);await Promise.all(r.map(async r=>{let t=o[r];return t&&t.fileType?["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.google-earth.kml+xml"].includes(t.fileType)?y(t,r):P(g,t,r,e):void 0}))}};await Promise.all([S(n,["rutCliente","boleta","poder","f2","diagrama","otrasImagenes"],"nroEmpalme"),S(l,["memoriaCalculo"],"nroInstalacion"),S(s,["imagenTecho"],["nroInstalacion","nroAgua"])]),r.status(200).json({message:"Proyecto y archivos guardados con \xe9xito",idProject:g})}catch(e){console.error("âŒ Error al guardar en base de datos:",e),r.status(500).json({error:"Error al guardar proyecto"})}}let g=(0,l.l)(o,"default"),y=(0,l.l)(o,"config"),P=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/saveProject",pathname:"/api/saveProject",bundlePath:"",filename:""},userland:o})},11001:(e,r,t)=>{t.d(r,{P:()=>l});var o=t(19424),a=t.n(o);let n={isConnected:0,pool:null};async function l(){if(n.isConnected&&n.pool)return console.log("âœ… En connectToDB ya existe una conexi\xf3n",n.pool),n.pool;try{let e=function(){let e=process.env.DATABASE_URL;if(e){let r=new URL(e),[t,o]=r.username?[r.username,r.password]:[void 0,void 0];return{user:t,password:o,server:r.hostname,port:parseInt(r.port||"1433",10),database:r.searchParams.get("database")||"",options:{trustServerCertificate:!0,encrypt:!0},connectionTimeout:3e4}}return{user:process.env.DB_USER||"sa",password:process.env.DB_PASSWORD||"as",server:process.env.DB_SERVER||"localhost",database:process.env.DB_NAME||"fotvAdmin",options:{trustServerCertificate:!0,encrypt:!0},port:Number(process.env.DB_PORT||1433),connectionTimeout:3e4,requestTimeout:6e4}}(),r=await a().connect(e);return n.isConnected=1,n.pool=r,console.log("âœ… En getDbConfig Conexi\xf3n a SQL Server establecida"),r}catch(e){throw console.error("âŒ Error conectando a SQL Server:",e),e}}},18023:(e,r,t)=>{t.d(r,{B3:()=>l,JT:()=>n,Jz:()=>i,OB:()=>a,nS:()=>s});var o=t(11001);let a=async(e,r=[])=>{try{console.log(`â–¶ï¸ Ejecutando SP: ${e} con nro. params:`,r.length);let t=(await (0,o.P)()).request();r.forEach(e=>{t.input(e.name,e.type,e.value)});let a=await t.execute(e);return console.log(`âœ… SP ejecutado correctamente: ${e}`),a.recordset}catch(t){throw console.error(`âŒ Error ejecutando SP "${e}" con par\xe1metros:`,r),console.error("\uD83E\uDDE8 Detalles del error:",t),t}},n=async(e,r=[])=>{console.log("En executeQuery connectToDB",o.P);try{console.log(`ðŸ“¥ Ejecutando consulta: "${e}" con params:`,r);let t=(await (0,o.P)()).request();r.forEach(e=>{t.input(e.name,e.type,e.value)});let a=await t.query(e);return console.log(`âœ… Consulta ${e} ejecutada correctamente (${a.recordset.length} filas)`),a.recordset}catch(r){throw console.error(`âŒ Error ejecutando consulta SQL: "${e}"`),console.error("\uD83E\uDDE8 Detalles del error:",r),r}},l=async(e,r=[])=>{try{let t=(await (0,o.P)()).request();return r.forEach(e=>{t.input(e.name,e.type,e.value)}),(await t.execute(e)).rowsAffected[0]??!0}catch(r){throw console.error(`âŒ Error ejecutando SP "${e}"`,r),r}},i=async(e,r=[])=>{let t=await n(e,r);return t.length>0?t[0]:null},s=async(e,r=[])=>{try{let t=(await (0,o.P)()).request();r.forEach(e=>t.input(e.name,e.type,e.value));let a=await t.execute(e);return console.log(`âœ… En executeSPScalar ${e}`),a.recordset.length>0?a.recordset[0]:null}catch(r){return console.error(`âŒ Error en executeSPScalar SP "${e}":`,r),null}}},47153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},71802:(e,r,t)=>{e.exports=t(20145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=84683);module.exports=t})();